<section class="panel">
  <header class="panel__header">
    <div>
      <h2 class="panel__title">
        Products
        <span class="badge-count">{{ totalProducts() }}</span>
      </h2>
      <p class="panel__subtitle">
        Add items to your cart. Offers are applied automatically.
      </p>
    </div>

    <div class="panel__filters">
      <div class="filter-switch">
        <button
          type="button"
          class="filter-switch__btn"
          [class.is-active]="sortMode() === 'all'"
          (click)="setSortMode('all')"
        >
          All
        </button>

        <button
          type="button"
          class="filter-switch__btn"
          [class.is-active]="sortMode() === 'with-offer'"
          (click)="setSortMode('with-offer')"
        >
          With offers
        </button>

        <button
          type="button"
          class="filter-switch__btn"
          [class.is-active]="sortMode() === 'without-offer'"
          (click)="setSortMode('without-offer')"
        >
          No offers
        </button>
      </div>
    </div>
  </header>

  @if (productService.loading) {
    <div class="loading">Loading products…</div>
  }

  @if (productService.error) {
    <div class="error">
      Failed to load products from API. Using fallback data.
    </div>
  }

  <div class="product-grid">
    @for (p of visibleProducts(); track p.sku) {
      <article
        class="product-card"
        data-testid="product-card"
        [class.product-card--has-offer]="p.offer && !isOfferExpired(p)"
        [class.product-card--offer-active]="p.offer && isOfferActive(p)"
        [class.product-card--offer-expired]="p.offer && isOfferExpired(p)"
      >
        <div class="product-card__header">
          <div class="product-card__avatar">
            {{ p.name[0] }}
          </div>
          <div>
            <div class="product-card__name">{{ p.name }}</div>

            @if (p.offer) {
              <span
                class="product-card__deal-tag"
                [class.product-card__deal-tag--active]="isOfferActive(p)"
                [class.product-card__deal-tag--expired]="isOfferExpired(p)"
              >
                @if (isOfferActive(p)) {
                  Offer this week
                } @else if (isOfferExpired(p)) {
                  Offer recently expired
                } @else {
                  Upcoming offer
                }
              </span>
            }
          </div>
        </div>

        <div class="product-card__body">
          <div class="product-card__price">€{{ p.unitPrice }}</div>

          @if (p.offer && !isOfferExpired(p)) {
            <div class="product-card__offer">
              <span class="product-card__offer-label">Offer</span>
              <span class="product-card__offer-value">
                {{ p.offer.quantity }} for €{{ p.offer.price }}
              </span>
            </div>

            @if (p.offer.validFrom || p.offer.validTo) {
              <div class="product-card__offer-dates">
                @if (p.offer.validFrom && p.offer.validTo) {
                  <span>
                    Valid
                    {{ p.offer.validFrom | date: 'MMM d' }}
                    –
                    {{ p.offer.validTo | date: 'MMM d' }}
                  </span>
                } @else if (p.offer.validFrom) {
                  <span>
                    Valid from
                    {{ p.offer.validFrom | date: 'MMM d' }}
                  </span>
                } @else if (p.offer.validTo) {
                  <span>
                    Valid until
                    {{ p.offer.validTo | date: 'MMM d' }}
                  </span>
                }
              </div>
            }
          }
        </div>

        <div class="product-card__footer">
          <div class="product-card__qty">
            <span class="qty-select__label">Qty</span>
            <select
              class="qty-select__control"
              [value]="getQuantity(p.sku)"
              (change)="onQuantityChange(p.sku, $any($event.target).value)"
            >
              @for (q of quantityOptions; track q) {
                <option [value]="q">{{ q }}</option>
              }
            </select>
          </div>

          <button
            type="button"
            class="btn btn--primary product-card__btn"
            data-testid="add-to-cart"
            (click)="add(p.sku)"
          >
            Add to cart
          </button>
        </div>

        @if (lastAddedSku() === p.sku) {
          <div class="product-card__feedback">
            Added {{ getQuantity(p.sku) }}
            item{{ getQuantity(p.sku) === 1 ? '' : 's' }} to cart
          </div>
        }
      </article>
    }
  </div>

  @if (totalPages() > 1) {
    <div class="pagination">
      <button
        type="button"
        class="btn btn--ghost pagination__btn"
        (click)="changePage(-1)"
        [disabled]="currentPage() === 1"
      >
        ← Previous
      </button>

      <div class="pagination__info">
        Page {{ currentPage() }} of {{ totalPages() }}
      </div>

      <button
        type="button"
        class="btn btn--ghost pagination__btn"
        (click)="changePage(1)"
        [disabled]="currentPage() === totalPages()"
      >
        Next →
      </button>
    </div>
  }

  <footer class="panel__footer panel__footer--products">
    <div class="panel__footer-info">
      <span class="panel__footer-label">Items in cart</span>
      <span class="panel__footer-value">
        {{ cartCount() }}
      </span>
    </div>

    <button
      type="button"
      class="btn btn--ghost panel__footer-cta panel__footer-cta--checkout"
      [routerLink]="cartCount() > 0 ? '/checkout' : null"
      [disabled]="cartCount() === 0"
      [attr.aria-disabled]="cartCount() === 0"
      (click)="cartCount() === 0 && $event.preventDefault()"
    >
      <span>Proceed to checkout</span>

      @if (cartCount() > 0) {
        <span class="btn-badge">{{ cartCount() }}</span>
      }
    </button>
  </footer>
</section>
